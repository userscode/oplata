<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC –û–ø–ª–∞—Ç–∞</title>
    <style>
        /* –ø—Ä–µ–¥—ã–¥—É—â–∏–µ —Å—Ç–∏–ª–∏ */
        .permission-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        
        .permission-box {
            background: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            max-width: 300px;
            margin: 20px;
        }
        
        .permission-button {
            background: #3498db;
            color: white;
            border: none;
            padding: 15px 25px;
            font-size: 16px;
            border-radius: 25px;
            cursor: pointer;
            margin: 10px;
        }
        
        .permission-button:hover {
            background: #2980b9;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="payment-container">
        <div class="nfc-icon">üì±</div>
        <div class="status-message" id="statusMessage">
            –î–ª—è –æ–ø–ª–∞—Ç—ã —Ç—Ä–µ–±—É–µ—Ç—Å—è –¥–æ—Å—Ç—É–ø –∫ NFC
        </div>
        <div class="amount">
            <span class="currency">‚ÇΩ</span> 34,57
        </div>
        
        <div class="permission-overlay" id="permissionOverlay">
            <div class="permission-box">
                <h3>–î–æ—Å—Ç—É–ø –∫ NFC</h3>
                <p>–î–ª—è —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è NFC –º–µ—Ç–æ–∫ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ.</p>
                <p>–ü–æ—Å–ª–µ –Ω–∞–∂–∞—Ç–∏—è "–†–∞–∑—Ä–µ—à–∏—Ç—å" –º–æ–∂–µ—Ç –ø–æ—è–≤–∏—Ç—å—Å—è —Å–∏—Å—Ç–µ–º–Ω–æ–µ –æ–∫–Ω–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</p>
                <button class="permission-button" onclick="requestNFCPermission()">
                    üì± –†–∞–∑—Ä–µ—à–∏—Ç—å NFC
                </button>
                <button class="permission-button" style="background: #95a5a6;" onclick="showManualInstructions()">
                    –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è
                </button>
            </div>
        </div>

        <div class="scanning-animation hidden" id="scanningAnimation"></div>
        <div class="loader hidden" id="loader"></div>
        
        <div class="instructions hidden" id="manualInstructions">
            <h4>–†—É—á–Ω–∞—è –Ω–∞—Å—Ç—Ä–æ–π–∫–∞ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–π:</h4>
            1. –û—Ç–∫—Ä–æ–π—Ç–µ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ Chrome</strong><br>
            2. –ü–µ—Ä–µ–π–¥–∏—Ç–µ –≤ <strong>–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∞–π—Ç–∞</strong><br>
            3. –ù–∞–π–¥–∏—Ç–µ —ç—Ç–æ—Ç —Å–∞–π—Ç –≤ —Å–ø–∏—Å–∫–µ<br>
            4. –†–∞–∑—Ä–µ—à–∏—Ç–µ –¥–æ—Å—Ç—É–ø –∫ <strong>NFC</strong><br>
            5. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É<br>
            <button onclick="hideManualInstructions()">–ó–∞–∫—Ä—ã—Ç—å</button>
        </div>
    </div>

    <script>
        let nfcReader = null;
        let paymentCompleted = false;

        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        document.addEventListener('DOMContentLoaded', function() {
            showPermissionRequest();
        });

        function showPermissionRequest() {
            document.getElementById('permissionOverlay').classList.remove('hidden');
        }

        function hidePermissionRequest() {
            document.getElementById('permissionOverlay').classList.add('hidden');
        }

        function showManualInstructions() {
            document.getElementById('manualInstructions').classList.remove('hidden');
        }

        function hideManualInstructions() {
            document.getElementById('manualInstructions').classList.add('hidden');
        }

        // –û—Å–Ω–æ–≤–Ω–æ–π –∑–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è NFC
        async function requestNFCPermission() {
            updateStatus('–ó–∞–ø—Ä–∞—à–∏–≤–∞—é –¥–æ—Å—Ç—É–ø –∫ NFC...');
            
            if (!('NDEFReader' in window)) {
                updateStatus('NFC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º –±—Ä–∞—É–∑–µ—Ä–æ–º');
                showError('–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –¥–ª—è Android –≤–µ—Ä—Å–∏–∏ 89+');
                return;
            }

            try {
                // –°–æ–∑–¥–∞–µ–º —ç–∫–∑–µ–º–ø–ª—è—Ä NFC Reader
                nfcReader = new NDEFReader();
                
                // –ü—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ - —ç—Ç–æ –∑–∞–ø—Ä–æ—Å–∏—Ç —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ
                updateStatus('–ó–∞–ø—Ä–æ—Å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏—è...');
                
                await nfcReader.scan();
                
                // –ï—Å–ª–∏ –¥–æ—à–ª–∏ —Å—é–¥–∞ - —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø–æ–ª—É—á–µ–Ω–æ
                hidePermissionRequest();
                updateStatus('–î–æ—Å—Ç—É–ø –ø–æ–ª—É—á–µ–Ω! –ü–æ–¥–Ω–µ—Å–∏—Ç–µ —Ç–µ–ª–µ—Ñ–æ–Ω –∫ NFC –º–µ—Ç–∫–µ...');
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∞–Ω–∏–º–∞—Ü–∏—é —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è
                document.getElementById('scanningAnimation').classList.remove('hidden');
                document.getElementById('loader').classList.remove('hidden');
                
                // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏
                setupNFCHandlers();
                
            } catch (error) {
                console.error('NFC Permission error:', error);
                handleNFCPermissionError(error);
            }
        }

        function setupNFCHandlers() {
            nfcReader.onreading = (event) => {
                console.log('NFC tag detected:', event);
                if (!paymentCompleted) {
                    updateStatus('–û–ø–ª–∞—Ç–∞ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è...');
                    setTimeout(completePayment, 1500);
                }
            };

            nfcReader.onreadingerror = (error) => {
                console.error('NFC read error:', error);
                updateStatus('–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è. –ü–æ–¥–Ω–µ—Å–∏—Ç–µ –º–µ—Ç–∫—É –±–ª–∏–∂–µ.');
            };
        }

        function handleNFCPermissionError(error) {
            let errorMessage = '';
            
            switch(error.name) {
                case 'NotAllowedError':
                    errorMessage = '–î–æ—Å—Ç—É–ø –∫ NFC –∑–∞–ø—Ä–µ—â–µ–Ω. –†–∞–∑—Ä–µ—à–∏—Ç–µ –≤ –Ω–∞—Å—Ç—Ä–æ–π–∫–∞—Ö Chrome.';
                    showManualInstructions();
                    break;
                case 'NotSupportedError':
                    errorMessage = 'NFC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è –≤–∞—à–∏–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º.';
                    break;
                case 'SecurityError':
                    errorMessage = '–¢—Ä–µ–±—É–µ—Ç—Å—è HTTPS —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ.';
                    break;
                default:
                    errorMessage = `–û—à–∏–±–∫–∞: ${error.message}`;
            }
            
            updateStatus(errorMessage);
            showError(errorMessage);
        }

        function completePayment() {
            paymentCompleted = true;
            updateStatus('–û–ø–ª–∞—á–µ–Ω–æ —É—Å–ø–µ—à–Ω–æ! ‚úÖ');
            document.getElementById('loader').classList.add('hidden');
            document.getElementById('scanningAnimation').classList.add('hidden');
            
            if (nfcReader) {
                // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–ª–∞—Ç—ã
                nfcReader = null;
            }
        }

        function updateStatus(message) {
            document.getElementById('statusMessage').textContent = message;
        }

        function showError(message) {
            // –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
            console.error(message);
        }

        // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ç–æ–¥—ã –¥–ª—è –æ–±—Ö–æ–¥–∞ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–π
        function alternativeActivationMethods() {
            // –ú–µ—Ç–æ–¥ 1: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø–æ —Ç–∞–ø—É –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.addEventListener('click', function() {
                if (!nfcReader && !paymentCompleted) {
                    requestNFCPermission();
                }
            });
            
            // –ú–µ—Ç–æ–¥ 2: –ê–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–∏ —Ñ–æ–∫—É—Å–µ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü–µ
            document.addEventListener('touchstart', function() {
                if (!nfcReader && !paymentCompleted) {
                    setTimeout(requestNFCPermission, 100);
                }
            });
        }
        
        // –ó–∞–ø—É—Å–∫–∞–µ–º –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–µ –º–µ—Ç–æ–¥—ã
        alternativeActivationMethods();
    </script>
</body>
</html>
